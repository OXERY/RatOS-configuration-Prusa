# WARNING. DO NOT EDIT THIS FILE.
# To override settings from this file, you can copy and paste the relevant
# sections into your printer.cfg and change it there.


#This replicates Prusa's calibrate Z funtionality.
[gcode_macro Tram_Z]
gcode:
    G28
    G1 X90 Y90 F3000
    G1 Z210 F1000 #Update with Z height.
    FORCE_MOVE STEPPER=stepper_z Distance=10 Velocity=10
    G28 Z
    
[gcode_macro Z_ALIGN_MOTORS]
gcode:
  {% set TRAM_CUR = 0.3 %}
	{% if printer["gcode_macro _stepper_type"].tmc2209|int == 1 %}
    {% set driver_config = printer.configfile.settings['tmc2209 stepper_z'] %}
	{% else %}
    {% set driver_config = printer.configfile.settings['tmc2130 stepper_z'] %}	
	{% endif %}
    {% set RUN_CUR = driver_config.run_current %}
    G28
    G1 X125 Y105 F2000
    G1 Z208 F1000
    SET_KINEMATIC_POSITION Z=203
	  SET_TMC_CURRENT STEPPER=stepper_z CURRENT={TRAM_CUR}
    G1 Z208 F100
    SET_TMC_CURRENT STEPPER=stepper_z CURRENT={RUN_CUR}
    G28 Z

[gcode_macro Emergency_Lift_Z]
gcode:
    SET_KINEMATIC_POSITION X=0 Y=0 Z=0
    G91
    G1 Z+10 F1500
    G90

[gcode_macro _START_PRINT_AFTER_HEATING_BED]
gcode:
  {% if printer["gcode_macro RatOS"].preheat_extruder|lower == 'true' %}
  M117 Pre-heating extruder...
  # Wait for extruder to reach 150 so an inductive probe (if present) is at a predictable temp. 
  # Also allows the bed heat to spread a little, and softens any plastic that might be stuck to the nozzle.
  M104 S150
  TEMPERATURE_WAIT SENSOR=extruder MINIMUM=150
  {% endif %}
  M117 Adjusting for tilt...
  # Adjust bed tilt
  Z_TILT_ADJUST
  M117 Rehoming after tilt adjustment...
  # Home again as Z will have changed after tilt adjustment and bed heating.
  G28 Z

[gcode_macro RatOS]    
variable_driver_type_x: "tmc2130"
variable_driver_type_y: "tmc2130"
